<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background: #eef2f3;
            text-align: center;
            padding: 20px;
        }

        .box {
            background: white;
            max-width: 500px;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        input {
            width: 90%;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-main {
            background: #2ecc71;
            color: white;
            width: 100%;
            font-size: 18px;
        }

        video {
            border-radius: 10px;
            margin: 10px 0;
            width: 100%;
            /* ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡πÄ‡∏á‡∏≤ User ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏á‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ */
            transform: scaleX(-1); 
        }

        /* ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á */
        #instruction {
            font-size: 20px;
            color: #3498db;
            font-weight: bold;
            margin-bottom: 5px;
        }

        #loader {
            display: none;
            color: #e67e22;
            font-weight: bold;
            margin-top: 20px;
            font-size: 18px;
        }

        #register-result {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f0fff4;
            border: 2px dashed #2ecc71;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div class="box">
        <h2>üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</h2>
        <form>
            <input type="text" id="name" name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠" required><br>
            <input type="text" id="surname" name="surname" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required><br>
            <input type="text" id="phone" name="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" required><br>
            
            <p id="instruction">üëâ ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á</p>

            <video id="video" autoplay playsinline></video>
            
            <p id="status">‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (0/8) ‡∏†‡∏≤‡∏û</p>
            
            <button type="button" onclick="capture()" style="background:#3498db; color:white;">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
            
            <button type="button" class="btn-main" disabled id="submitBtn" onclick="submitData()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
            
            <div id="loader">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•...<br>(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)</div>

            <div id="register-result">
                <h3 style="color: #27ae60;">‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
                <img id="detected-face-img" src="" style="width: 150px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <p style="color: #7f8c8d; font-size: 14px; margin-top:10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏ó‡πà‡∏≤‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...</p>
            </div>
        </form>
        <br><a href="/">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    </div>

    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const instruction = document.getElementById('instruction');
        const submitBtn = document.getElementById('submitBtn');
        const loader = document.getElementById('loader');
        const resultDiv = document.getElementById('register-result');
        const resultImg = document.getElementById('detected-face-img');
        
        let images = [];
        const TOTAL_IMAGES = 8; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô 8
        
        // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á
        const instructionsList = [
            "‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á",
            "‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà 2: ‡∏´‡∏±‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
            "‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà 3: ‡∏´‡∏±‡∏ô‡∏Ç‡∏ß‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
            "‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà 4: ‡∏Å‡πâ‡∏°‡∏´‡∏ô‡πâ‡∏≤",
            "‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà 5: ‡πÄ‡∏á‡∏¢‡∏´‡∏ô‡πâ‡∏≤",
            "‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà 6: ‡∏¢‡∏¥‡πâ‡∏°",
            "‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà 7: ‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤",
            "‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà 8: ‡∏ï‡∏≤‡πÇ‡∏ï",
        ];
        
        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        navigator.mediaDevices.getUserMedia({ video: true }).then(s => video.srcObject = s);

        function capture() {
            if (images.length >= TOTAL_IMAGES) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; 
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                images.push(blob);
                status.innerText = `‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (${images.length}/${TOTAL_IMAGES}) ‡∏†‡∏≤‡∏û`;
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                if (images.length < TOTAL_IMAGES) {
                    instruction.innerText = instructionsList[images.length];
                    instruction.style.color = "#3498db"; // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤
                } else {
                    // ‡∏Ñ‡∏£‡∏ö 5 ‡∏£‡∏π‡∏õ
                    instruction.innerText = "‚úÖ ‡∏ñ‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";
                    instruction.style.color = "green"; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    status.style.color = "green";
                    submitBtn.disabled = false;
                }
            }, 'image/jpeg');
        }

        function submitData() {
            const name = document.getElementById('name').value;
            const surname = document.getElementById('surname').value;
            const phone = document.getElementById('phone').value;

            if (!name || !surname || !phone) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á");
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('surname', surname);
            formData.append('phone', phone);
            
            images.forEach((img, i) => formData.append('image_' + i, img, `img_${i}.jpg`));

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÇ‡∏ä‡∏ß‡πå Loader
            submitBtn.style.display = 'none';
            loader.style.display = 'block';

            fetch('/register', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    // ‡∏ã‡πà‡∏≠‡∏ô Loader ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                    loader.style.display = 'none';

                    if (data.status === 'success') {
                        // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                        resultDiv.style.display = 'block';
                        
                        // 2. ‡πÄ‡∏≠‡∏≤‡∏£‡∏π‡∏õ Base64 ‡πÉ‡∏™‡πà‡πÉ‡∏ô img tag
                        if (data.example_image) {
                            resultImg.src = 'data:image/jpeg;base64,' + data.example_image;
                        }

                        // 3. ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 3000);

                    } else {
                        // ‡∏Å‡∏£‡∏ì‡∏µ Error
                        alert("‚ùå Error: " + data.message);
                        submitBtn.style.display = 'block';
                    }
                })
                .catch(err => {
                    loader.style.display = 'none';
                    submitBtn.style.display = 'block';
                    alert("Connection Error: " + err);
                });
        }
    </script>
</body>
</html>